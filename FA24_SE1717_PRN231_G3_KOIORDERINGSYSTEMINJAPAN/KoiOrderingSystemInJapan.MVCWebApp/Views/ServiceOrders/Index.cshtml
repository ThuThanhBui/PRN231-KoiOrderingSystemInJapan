<div class="row">
    <div class="col-md-10">
        <h3 class="display-8">Service Order List</h3>
    </div>
    <div class="col-md-2 text-end">
        <button type="button" class="btn btn-primary" onclick="addServiceOrder();">
            Add New
        </button>
    </div>
</div>

<!--Filter&Search-->
<div class="my-3">
    <h4 class="display-8">Filter&Search</h4>
    <div class="row">
        <div class="col-md-6 form-group flex-fill">
            <input type="number" class="form-control" id="quantity" placeholder="Quantity">
        </div>

        <div class="col-md-6 form-group flex-fill">
            <input type="number" class="form-control" id="totalPrice" placeholder="Total price">
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-md-6">
            <div>Created date</div>
            <div class="form-group flex-fill">
                <input type="date" class="form-control" id="createdDate" placeholder="Created date">
            </div>
        </div>

        <div class="col-md-6">
            <div>Updated date</div>
            <div class="form-group flex-fill">
                <input type="date" class="form-control" id="updatedDate" placeholder="Updated date">
            </div>
        </div>
    </div>
    <div>
        <button type="button" class="btn btn-outline-dark px-4 py-2 mt-2" onclick="resetData(); loadData(1);">Reset</button>
        <button type="button" class="btn btn-dark px-4 py-2 mt-2" onclick="loadData(1)">Search</button>
    </div>
</div>

<!--List-->
<div class="row">
    <div class="col-md-12">
        <table class="table table-striped table-bordered table-hover">
            <thead>
                <tr class="card-header">
                    <th class="card-title text-center">Quantity</th>
                    <th class="card-title text-center">Total price</th>
                    <th class="card-title text-center">Note</th>
                    <th class="card-title text-center">Created date</th>
                    <th class="card-title text-center">Updated date</th>
                    <th class="card-title"></th>
                </tr>
            </thead>
            <tbody class="tblServiceOrders"></tbody>
        </table>
        <div class="d-flex justify-content-center align-items-center text-center ">
            <button class="btn btn-light" id="prevPage" onclick="loadData(currentPage - 1)" disabled>Previous</button>
            <span id="currentPageLabel">Page 1</span>
            <button class="btn btn-light" id="nextPage" onclick="loadData(currentPage + 1)">Next</button>
        </div>
    </div>
</div>

<!--Modal detail-->
<div class="modal fade" id="serviceOrderModalView" tabindex="-1" aria-labelledby="serviceOrderModalViewLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="serviceOrderModalViewLabel">Service Order Details</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label><strong>Quantity:</strong></label>
                        <p id="quantityDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Total Price:</strong></label>
                        <p id="totalPriceDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Created By:</strong></label>
                        <p id="createdByDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Created Date:</strong></label>
                        <p id="createdDateDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Updated By:</strong></label>
                        <p id="updatedByDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Updated Date:</strong></label>
                        <p id="updatedDateDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Note:</strong></label>
                        <p id="noteDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Deleted:</strong></label>
                        <p id="isDeletedDetail"></p>
                    </div>
                </div>
                <div class="row">
                    <label><strong>Booking Request Information</strong></label>
                    <div class="col-md-6">
                        <label><strong>Customer Name:</strong></label>
                        <p id="customerNameDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Travel Name:</strong></label>
                        <p id="travelNameDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Quantity Service:</strong></label>
                        <p id="quantityServiceDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Number of People:</strong></label>
                        <p id="numberOfPersonDetail"></p>
                    </div>
                </div>
                <div class="row">
                    <label><strong>Invoic Infomation</strong></label>
                    <div class="col-md-6">
                        <label><strong>Payment amount: </strong></label>
                        <p id="paymentAmountDetail"></p>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Payment date: </strong></label>
                        <p id="paymentDateDetail"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!--Modal add-->
<div class="modal" id="serviceOrderModalAdd" tabindex="-1" aria-labelledby="serviceOrderModalLabelAdd" aria-hidden="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "frmServiceOrder" }))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceOrderModalLabelAdd">Service Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bookingRequestIdAdd" />
                    <label for="bookingRequest">Booking request</label>
                    <div id="bookingRequestCardsAdd" class="row overflow-auto" style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                        <!-- Các card sẽ được thêm động từ JavaScript -->
                    </div>
                    <div class="col-md-6">
                        <label>Quantity</label>
                        <input type="number" id="quantityAdd" name="Quantity" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label>Total Price</label>
                        <input type="number" id="totalPriceAdd" name="TotalPrice" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label>Note</label>
                        <input type="text" id="noteAdd" name="Note" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btSaveAddServiceOrder" type="button" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            }
        </div>
    </div>
</div>

<!--Modal update-->
<div class="modal" id="serviceOrderModalUpdate" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Service Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="serviceOrderId" />
                <input type="hidden" id="createdDateUpdate" />
                <input type="hidden" id="bookingRequestIdUpdate" />
                <label for="bookingRequest">Booking request</label>
                <div id="bookingRequestCardsUpdate" class="row overflow-auto" style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                    <!-- Các card sẽ được thêm động từ JavaScript -->
                </div>
                <div class="mb-3">
                    <label for="Quantity" class="form-label">Quantity</label>
                    <input type="number" id="quantityUpdate" class="form-control" />
                </div>
                <div class="mb-3">
                    <label for="TotalPrice" class="form-label">Total Price</label>
                    <input type="number" id="totalPriceUpdate" class="form-control" />
                </div>
                <div class="mb-3">
                    <label for="Note" class="form-label">Note</label>
                    <textarea id="noteUpdate" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btSaveUpdateServiceOrder" type="button" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        let currentPage = 1;
        $(document).ready(function () {
            loadData(currentPage);
        });

        function loadData(page) {
            currentPage = page;

            var data = {
                TotalPrice: $('#totalPrice').val() || null,
                Quantity: $('#quantity').val() || null,
                CreatedDate: $('#createdDate').val() ? new Date($('#createdDate').val()).toISOString() : null,
                UpdatedDate: $('#updatedDate').val() ? new Date($('#updatedDate').val()).toISOString() : null,
                Page: currentPage,
                PageSize: 7 // Kích thước trang cố định
            };

            $.ajax({
                url: 'https://localhost:7298/api/ServiceOrders/filter',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: JSON.stringify(data),
                success: function (result) {
                    var html = '';
                    $.each(result.data.list, function (key, item) {
                        html += '<tr>';
                        html += '<td>' + (item.quantity ?? 'N/A') + '</td>';
                        html += '<td>' + item.totalPrice + '</td>';
                        html += '<td>' + (item.note ?? 'N/A') + '</td>';
                        html += '<td>' + (formatDate(item.createdDate)) ?? 'N/A' + '</td>';
                        html += '<td>' + (formatDate(item.updatedDate)) ?? 'N/A' + '</td>';
                        // Thêm nút Update và Delete
                        html += `<td>
                                                    <button class="btn btn-info btn-sm me-2" onclick="viewDetail('${item.id}')">Detail</button>
                                                    <button class="btn btn-warning btn-sm me-2" onclick="getUpdateServiceOrder('${item.id}')">Update</button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteServiceOrder('${item.id}')">Delete</button></td>`;
                        html += '</tr>';
                    });
                    $('.tblServiceOrders').html(html);

                    // Cập nhật trạng thái nút phân trang
                    updatePagination(result.data.totalPages);
                },
                error: function (xhr, error) {
                    alert("load data fail" + xhr.statusText);
                }
            });
        }

        //reset data
        function resetData() {
            $('#quantity').val('');
            $('#totalPrice').val('');
            $('#createdDate').val('');
            $('#updatedDate').val('');
        }

        //Nhan btn detail
        function viewDetail(id) {
            $.ajax({
                url: `https://localhost:7298/api/ServiceOrders/${id}`,
                type: "GET",
                success: function (result) {
                    if (result.data) {
                        const serviceOrder = result.data;
                        const booking = serviceOrder.bookingRequest;
                        const invoice = serviceOrder.invoice;

                        // Gán dữ liệu của ServiceOrder vào các thẻ trong modal
                        $("#totalPriceDetail").text(serviceOrder.totalPrice ?? "N/A");
                        $("#quantityDetail").text(serviceOrder.quantity ?? "N/A");
                        $("#createdByDetail").text(serviceOrder.createdBy ?? "N/A");
                        $("#createdDateDetail").text(formatDate(serviceOrder.createdDate));
                        $("#updatedByDetail").text(serviceOrder.updatedBy ?? "N/A");
                        $("#updatedDateDetail").text(formatDate(serviceOrder.updatedDate));
                        $("#noteDetail").text(serviceOrder.note ?? "N/A");
                        $("#isDeletedDetail").text(serviceOrder.isDeleted ? "Yes" : "No");

                        // Gán dữ liệu của BookingRequest vào các thẻ trong modal
                        if (booking) {
                            $("#customerNameDetail").text(`${booking.customer.firstname} ${booking.customer.lastname}`);
                            $("#travelNameDetail").text(booking.travel.name);
                            $("#quantityServiceDetail").text(booking.quantityService);
                            $("#numberOfPersonDetail").text(booking.numberOfPerson);
                        } else {
                            $("#customerNameDetail").text("N/A");
                            $("#travelNameDetail").text("N/A");
                            $("#quantityServiceDetail").text("N/A");
                            $("#numberOfPersonDetail").text("N/A");
                        }

                        // Gán dữ liệu của Invoice vào các thẻ trong modal
                        if (invoice) {
                            $("#paymentAmountDetail").text(invoice.paymentAmount);
                            $("#paymentDateDetail").text(formatDate(invoice.paymentDate));
                        } else {
                            $("#paymentAmountDetail").text("N/A");
                            $("#paymentDateDetail").text("N/A");
                        }

                        // Hiển thị modal
                        $('#serviceOrderModalView').modal('show');
                    } else {
                        alert("Service order not found.");
                    }
                },
                error: function (xhr, error) {
                    console.error("Error fetching service order details:", xhr);
                    alert("Failed to load service order details.");
                }
            });
        }

        //nhan btn add
        function addServiceOrder() {
            $("#serviceOrderModalLabelAdd").html("Add New Service Order");
            $('#serviceOrderModalAdd').modal('show');
            loadBookingRequestsAdd();
        }

        //save add
        $("#btSaveAddServiceOrder").click(function () {
            const serviceOrder = {
                BookingRequestId: $("#bookingRequestIdAdd").val(),
                Quantity: $("#quantityAdd").val(),
                TotalPrice: $("#totalPriceAdd").val(),
                Note: $("#noteAdd").val(),
            };

            $.ajax({
                type: 'POST',
                url: 'https://localhost:7298/api/ServiceOrders',
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(serviceOrder),
                success: function (result) {
                    if (result.status >= 1) {
                        $('#serviceOrderModalAdd').modal('hide');
                        $("#bookingRequestIdAdd").val('');
                        $("#quantityAdd").val('');
                        $("#totalPriceAdd").val('');
                        $("#noteAdd").val('');
                    }
                    alert(result.message);
                },
                error: function (xhr, error) {
                    console.log(xhr);
                    alert('Error occurred while saving.');
                }
            });
        });

        //nhan btn update
        function getUpdateServiceOrder(id) {
            $.ajax({
                url: `https://localhost:7298/api/ServiceOrders/${id}`,
                type: "GET",
                success: function (item) {
                    // Kiểm tra xem item có dữ liệu hay không
                    console.log(item);
                    if (item.data) {
                        $("#bookingRequestIdUpdate").val(item.data.bookingRequestId);
                        $("#serviceOrderId").val(item.data.id);
                        $("#quantityUpdate").val(item.data.quantity);
                        $("#totalPriceUpdate").val(item.data.totalPrice);
                        $("#noteUpdate").val(item.data.note);
                        $("#createdDateUpdate").val(item.data.createdDate);

                        // Mở modal cập nhật
                        $('#serviceOrderModalUpdate').modal('show');
                        loadBookingRequestsUpdate();
                    } else {
                        alert("Service order not found.");
                    }
                },
                error: function (xhr, error) {
                    console.log(xhr);
                    alert("Failed to load service order.");
                }
            });
        }

        //save update
        $("#btSaveUpdateServiceOrder").click(function () {
            var serviceOrder = {
                Id: $("#serviceOrderId").val(),
                BookingRequestId: $("#bookingRequestIdUpdate").val(),
                Quantity: $("#quantityUpdate").val(),
                TotalPrice: $("#totalPriceUpdate").val(),
                Note: $("#noteUpdate").val(),
                CreatedDate: $("#createdDateUpdate").val()
            };

            $.ajax({
                type: 'PUT',
                url: `https://localhost:7298/api/ServiceOrders/${serviceOrder.id}`,
                data: JSON.stringify(serviceOrder),
                contentType: "application/json;charset=utf-8",
                success: function (result) {
                    alert("Service order updated successfully.");
                    $('#serviceOrderModalUpdate').modal('hide');
                    loadData(1);
                },
                error: function (xhr, error) {
                    console.log(xhr);
                    alert("Failed to update service order.");
                }
            });
        });

        //delete => updateIsDeleted
        function deleteServiceOrder(id) {
            if (confirm("Are you sure you want to delete this service order?")) {
                $.ajax({
                    url: `https://localhost:7298/api/ServiceOrders/update-isdeleted/${id}`,
                    type: "PUT",
                    success: function (result) {
                        alert("Service order deleted successfully.");
                        loadData(1); // Tải lại danh sách sau khi xóa
                    },
                    error: function (xhr, error) {
                        console.log(xhr);
                        alert("Failed to delete the service order.");
                    }
                });
            }
        }

        //load booking request add
        function loadBookingRequestsAdd() {
            $.ajax({
                type: 'GET',
                url: 'https://localhost:7298/api/BookingRequests/get-all',
                contentType: "application/json;charset=utf-8",
                success: function (rs) {
                    const cardsContainer = $("#bookingRequestCardsAdd");
                    cardsContainer.empty(); // Xóa nội dung cũ
                    rs.data.forEach(bookingRequest => {
                        const card = `
                                                    <div class="col-md-4">
                                                        <div class="card mb-3" data-id="${bookingRequest.id}" style="cursor: pointer;">
                                                            <div class="card-body">

                                                                <p class="card-text">Travel: ${bookingRequest.travel.name}</p>
                                                                <p class="card-text">Quantity: ${bookingRequest.quantityService}</p>
                                                                <p class="card-text">Number of Persons: ${bookingRequest.numberOfPerson}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        `;
                        cardsContainer.append(card);
                    });

                    // Thêm sự kiện click cho mỗi card
                    $(".card").click(function () {
                        const selectedId = $(this).data("id");
                        $("#bookingRequestIdAdd").val(selectedId);
                        console.log(selectedId)
                    });
                },
                error: function (xhr, error) {
                    console.log(xhr);
                    alert('Error occurred while loading booking requests.');
                }
            });
        }

        //load booking request update
        function loadBookingRequestsUpdate() {
            $.ajax({
                type: 'GET',
                url: 'https://localhost:7298/api/BookingRequests/get-all',
                contentType: "application/json;charset=utf-8",
                success: function (rs) {
                    const cardsContainer = $("#bookingRequestCardsUpdate");
                    cardsContainer.empty(); // Xóa nội dung cũ
                    rs.data.forEach(bookingRequest => {
                        const card = `
                                            <div class="col-md-4">
                                                <div class="card mb-3" data-id="${bookingRequest.id}" style="cursor: pointer;">
                                                    <div class="card-body">

                                                        <p class="card-text">Travel: ${bookingRequest.travelName}</p>
                                                        <p class="card-text">Quantity: ${bookingRequest.quantityService}</p>
                                                        <p class="card-text">Number of Persons: ${bookingRequest.numberOfPerson}</p>
                                                    </div>
                                                </div>
                                            </div>
                                                                `;
                        cardsContainer.append(card);
                    });

                    // Thêm sự kiện click cho mỗi card
                    $(".card").click(function () {
                        const selectedId = $(this).data("id");
                        $("#bookingRequestIdUpdate").val(selectedId);
                        console.log(selectedId)
                    });
                },
                error: function (xhr, error) {
                    console.log(xhr);
                    console.log(error);
                    alert('Error occurred while loading booking requests.');
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        //update phan trang
        function updatePagination(totalPages) {
            $('#currentPageLabel').text("Page " + currentPage);
            $('#prevPage').prop('disabled', currentPage === 1);
            $('#nextPage').prop('disabled', currentPage === totalPages);
        }
    </script>
}
